---
description: Extension Jobs WEDEV - File d'attente asynchrone
globs: ["**/Extension/Jobs/**/*.php"]
alwaysApply: false
---

# Extension Jobs WEDEV

## ğŸ¯ Objectif

File d'attente pour exÃ©cuter des tÃ¢ches lourdes de maniÃ¨re asynchrone.

## ğŸ“¦ Composants

| Composant | RÃ´le |
|-----------|------|
| `AbstractJob` | Classe de base pour les jobs |
| `JobDispatcher` | Met en queue et traite les jobs |
| `JobRepository` | Persistance en base de donnÃ©es |
| `JobEntry` | ReprÃ©sentation d'un job en queue |

## âœ… Bonnes Pratiques

### CrÃ©ation d'un Job

```php
// âœ… BON: Job atomique avec serialization complÃ¨te
final class SendEmailJob extends AbstractJob
{
    protected int $maxAttempts = 3;
    protected int $retryDelay = 120;
    protected int $timeout = 60;

    public function __construct(
        private readonly string $email,
        private readonly string $subject,
        private readonly string $content
    ) {}

    public function handle(): void
    {
        Mail::Send(...);
    }

    public function serialize(): array
    {
        return [
            'email' => $this->email,
            'subject' => $this->subject,
            'content' => $this->content,
        ];
    }

    public static function deserialize(array $data): self
    {
        return new self(
            $data['email'],
            $data['subject'],
            $data['content']
        );
    }
}
```

### Dispatch

```php
// âœ… BON: Dispatch avec dÃ©lai si appropriÃ©
$dispatcher->dispatch(new SendEmailJob(...), delay: 0);

// âœ… BON: Dispatch diffÃ©rÃ© pour rappels
$dispatcher->dispatch(
    new CartReminderJob($cartId),
    delay: 3600 * 24  // 24h plus tard
);

// âŒ MAUVAIS: Dispatcher des jobs trop lÃ©gers
$dispatcher->dispatch(new IncrementCounterJob());  // Trop rapide, pas besoin de queue
```

### Gestion des Erreurs

```php
// âœ… BON: GÃ©rer l'Ã©chec dÃ©finitif
public function onFailed(\Throwable $e): void
{
    // Notifier l'admin
    Mail::Send(
        ...,
        to: Configuration::get('ADMIN_EMAIL'),
        subject: 'Job failed: ' . $e->getMessage()
    );

    // Logger
    parent::onFailed($e);
}

// âœ… BON: Exceptions explicites
public function handle(): void
{
    if (!$this->validate()) {
        throw new \InvalidArgumentException('Invalid job data');
    }
    // ...
}
```

### Serialization

```php
// âœ… BON: Stocker les IDs, pas les objets
public function serialize(): array
{
    return ['product_id' => $this->productId];  // ID seulement
}

// âŒ MAUVAIS: Stocker des objets complexes
public function serialize(): array
{
    return ['product' => serialize($this->product)];  // Fragile!
}
```

## ğŸš« Anti-patterns

```php
// âŒ Jobs sans timeout appropriÃ©
protected int $timeout = 99999;

// âŒ Jobs avec dÃ©pendances externes non gÃ©rÃ©es
public function handle(): void
{
    $client = $this->container->get(HttpClient::class);  // Container non dispo!
}

// âŒ Retry infini
protected int $maxAttempts = 100;
```

## ğŸ“ Configuration CRON

```bash
# Traitement toutes les minutes
* * * * * curl -s "https://shop.com/module/mymodule/cron?token=XXX"

# Nettoyage hebdomadaire
0 3 * * 0 curl -s "https://shop.com/module/mymodule/cleanup?token=XXX"
```

## ğŸ“Š Monitoring

```php
$stats = $dispatcher->getQueueStats();
// ['pending' => 15, 'running' => 2, 'completed' => 1234, 'failed' => 3]

if ($stats['failed'] > 10) {
    // Alerter l'admin
}
```
