---
description: Hooks PrestaShop - Display et Action hooks avec exemples
globs: ["modulestarter.php", "src/**/*.php"]
alwaysApply: false
---

# Hooks PrestaShop

## ğŸª Concepts Fondamentaux

Les hooks sont le mÃ©canisme d'extension de PrestaShop:
- **Display hooks**: Retournent du HTML Ã  afficher
- **Action hooks**: DÃ©clenchent une logique sans retour

## ğŸ“ DÃ©claration des Hooks

```php
// Dans le module principal
class ModuleStarter extends Module
{
    /**
     * Liste EXHAUSTIVE des hooks utilisÃ©s par le module.
     * Tous les hooks DOIVENT Ãªtre listÃ©s ici.
     */
    public const HOOKS = [
        // Front Office - Display
        'displayHeader',
        'displayHome',
        'displayFooter',
        'displayProductAdditionalInfo',
        'displayShoppingCart',
        'displayOrderConfirmation',

        // Front Office - Actions
        'actionFrontControllerSetMedia',
        'actionCartSave',
        'actionValidateOrder',
        'actionCustomerAccountAdd',

        // Back Office
        'actionAdminControllerSetMedia',
        'actionObjectProductAddAfter',
        'actionObjectProductUpdateAfter',
    ];

    public function install(): bool
    {
        return parent::install()
            && $this->registerHook(self::HOOKS); // Enregistre TOUS les hooks d'un coup
    }
}
```

## ğŸ–¥ï¸ Display Hooks (Front-Office)

### displayHeader - CSS/JS dans `<head>`

```php
/**
 * Ajoute des assets dans le <head> de la page.
 *
 * @param array{cookie: Cookie, cart: Cart} $params
 */
public function hookDisplayHeader(array $params): string
{
    // VÃ©rifier si le module est actif
    if (!$this->isActive()) {
        return '';
    }

    // Enregistrer le CSS
    $this->context->controller->registerStylesheet(
        'modulestarter-front',                              // ID unique
        'modules/' . $this->name . '/views/css/front.css',  // Chemin relatif
        [
            'media' => 'all',        // all, screen, print
            'priority' => 150,       // Plus bas = chargÃ© avant (default: 50)
            'version' => $this->version,
        ]
    );

    // CSS conditionnel selon la page
    $controller = Tools::getValue('controller');
    if ($controller === 'product') {
        $this->context->controller->registerStylesheet(
            'modulestarter-product',
            'modules/' . $this->name . '/views/css/product.css',
            ['media' => 'all', 'priority' => 151]
        );
    }

    // Retourner du HTML inline si nÃ©cessaire (rare)
    return '';
}
```

### displayHome - Page d'accueil

```php
/**
 * Affiche du contenu sur la page d'accueil.
 *
 * @param array{cookie: Cookie, cart: Cart} $params
 * @return string HTML Ã  afficher
 */
public function hookDisplayHome(array $params): string
{
    if (!$this->isActive()) {
        return '';
    }

    // Utiliser le cache Smarty pour les performances
    $cacheId = $this->getCacheId('home');

    if (!$this->isCached('module:modulestarter/views/templates/hook/home.tpl', $cacheId)) {
        // RÃ©cupÃ©rer les donnÃ©es via le service (pas directement la DB!)
        $service = $this->getService(ModuleStarterService::class);
        $items = $service->getActiveItems();

        // Assigner les variables au template
        $this->context->smarty->assign([
            'modulestarter' => [
                'items' => $items,
                'title' => $this->getConfig()->get('MODULESTARTER_TITLE'),
                'link' => $this->context->link->getModuleLink($this->name, 'display'),
            ],
        ]);
    }

    // Syntaxe module: pour les templates dans views/templates/
    return $this->fetch('module:modulestarter/views/templates/hook/home.tpl', $cacheId);
}
```

### displayProductAdditionalInfo - Fiche produit

```php
/**
 * Affiche des informations supplÃ©mentaires sur la fiche produit.
 *
 * @param array{product: ProductLazyArray|array} $params
 */
public function hookDisplayProductAdditionalInfo(array $params): string
{
    if (!$this->isActive()) {
        return '';
    }

    // RÃ©cupÃ©rer le produit (attention: peut Ãªtre un array ou un objet)
    $product = $params['product'];

    // RÃ©cupÃ©rer l'ID produit de maniÃ¨re sÃ©curisÃ©e
    $productId = is_array($product)
        ? (int) ($product['id_product'] ?? 0)
        : (int) ($product->id ?? 0);

    if ($productId === 0) {
        return '';
    }

    // RÃ©cupÃ©rer des donnÃ©es spÃ©cifiques au produit
    $service = $this->getService(ModuleStarterService::class);
    $productData = $service->getProductData($productId);

    if ($productData === null) {
        return '';
    }

    $this->context->smarty->assign([
        'modulestarter_product' => $productData,
    ]);

    return $this->fetch('module:modulestarter/views/templates/hook/product-info.tpl');
}
```

### displayShoppingCart - Panier

```php
/**
 * Affiche du contenu dans le panier.
 *
 * @param array{cart: Cart, products: array} $params
 */
public function hookDisplayShoppingCart(array $params): string
{
    if (!$this->isActive()) {
        return '';
    }

    /** @var Cart $cart */
    $cart = $params['cart'];

    // Calculer quelque chose basÃ© sur le panier
    $cartTotal = (float) $cart->getOrderTotal(true, Cart::BOTH);

    $this->context->smarty->assign([
        'cart_total' => $cartTotal,
        'show_promo' => $cartTotal > 100,
    ]);

    return $this->fetch('module:modulestarter/views/templates/hook/cart.tpl');
}
```

## âš¡ Action Hooks (Front-Office)

### actionFrontControllerSetMedia - Chargement JS

```php
/**
 * Charge les assets JavaScript sur les pages front.
 *
 * @param array{} $params (vide pour ce hook)
 */
public function hookActionFrontControllerSetMedia(array $params): void
{
    if (!$this->isActive()) {
        return;
    }

    $controller = Tools::getValue('controller');

    // JS uniquement sur certaines pages
    $jsPages = ['product', 'category', 'index', 'cart', 'order'];

    if (in_array($controller, $jsPages, true)) {
        $this->context->controller->registerJavascript(
            'modulestarter-front',
            'modules/' . $this->name . '/views/js/front.js',
            [
                'position' => 'bottom',      // head ou bottom
                'priority' => 150,
                'attributes' => 'defer',     // defer, async, ou vide
            ]
        );
    }

    // Passer des donnÃ©es au JavaScript
    Media::addJsDef([
        'modulestarterConfig' => [
            'ajaxUrl' => $this->context->link->getModuleLink($this->name, 'ajax'),
            'token' => Tools::getToken(false),
            'lang' => $this->context->language->iso_code,
        ],
    ]);
}
```

### actionValidateOrder - Commande validÃ©e

```php
/**
 * DÃ©clenchÃ© APRÃˆS la validation d'une commande.
 *
 * @param array{
 *     cart: Cart,
 *     order: Order,
 *     customer: Customer,
 *     currency: Currency,
 *     orderStatus: OrderState
 * } $params
 */
public function hookActionValidateOrder(array $params): void
{
    if (!$this->isActive()) {
        return;
    }

    /** @var Order $order */
    $order = $params['order'];

    /** @var Customer $customer */
    $customer = $params['customer'];

    try {
        // DÃ©lÃ©guer au service
        $this->getService(OrderService::class)->onOrderValidated(
            $order->id,
            $order->reference,
            (float) $order->total_paid,
            $customer->email
        );

        $this->log('Order processed', 1, [
            'order_id' => $order->id,
            'reference' => $order->reference,
        ]);
    } catch (\Exception $e) {
        // IMPORTANT: Ne jamais faire Ã©chouer la commande Ã  cause du module!
        $this->log('Order hook failed: ' . $e->getMessage(), 3);
    }
}
```

### actionCartSave - Sauvegarde du panier

```php
/**
 * DÃ©clenchÃ© Ã  chaque modification du panier.
 *
 * âš ï¸ ATTENTION: Ce hook est appelÃ© TRÃˆS frÃ©quemment!
 * Ã‰vitez les opÃ©rations lourdes.
 *
 * @param array{cart: Cart} $params
 */
public function hookActionCartSave(array $params): void
{
    if (!$this->isActive()) {
        return;
    }

    /** @var Cart $cart */
    $cart = $params['cart'] ?? $this->context->cart;

    // Exemple: Invalider un cache quand le panier change
    $cacheKey = 'modulestarter_cart_' . $cart->id;
    Cache::getInstance()->delete($cacheKey);

    // Log en mode debug uniquement (ce hook est trÃ¨s frÃ©quent)
    if ($this->isDebugEnabled()) {
        $this->log('Cart saved', 1, ['cart_id' => $cart->id]);
    }
}
```

### actionCustomerAccountAdd - Nouveau client

```php
/**
 * DÃ©clenchÃ© aprÃ¨s l'inscription d'un nouveau client.
 *
 * @param array{newCustomer: Customer} $params
 */
public function hookActionCustomerAccountAdd(array $params): void
{
    if (!$this->isActive()) {
        return;
    }

    /** @var Customer $customer */
    $customer = $params['newCustomer'];

    // Exemple: Ajouter Ã  une liste de diffusion
    $this->getService(NewsletterService::class)->subscribeCustomer(
        $customer->email,
        $customer->firstname,
        $customer->lastname
    );

    // Exemple: Envoyer Ã  un CRM
    $this->getService(CrmService::class)->createContact([
        'email' => $customer->email,
        'firstname' => $customer->firstname,
        'lastname' => $customer->lastname,
        'source' => 'prestashop_registration',
    ]);
}
```

## ğŸ”§ Action Hooks (Back-Office)

### actionAdminControllerSetMedia - Assets admin

```php
/**
 * Charge les assets dans le back-office.
 *
 * @param array{} $params
 */
public function hookActionAdminControllerSetMedia(array $params): void
{
    // Uniquement sur la page de configuration du module
    if (!$this->isConfigurationPage()) {
        return;
    }

    $this->context->controller->addCSS($this->_path . 'views/css/admin.css');
    $this->context->controller->addJS($this->_path . 'views/js/admin.js');

    // Variables JS pour l'admin
    Media::addJsDef([
        'moduleStarterAdminUrl' => $this->context->link->getAdminLink(
            'AdminModuleStarterConfiguration'
        ),
    ]);
}

private function isConfigurationPage(): bool
{
    return $this->context->controller instanceof AdminModulesController
        && Tools::getValue('configure') === $this->name;
}
```

### actionObjectProductAddAfter - AprÃ¨s ajout produit

```php
/**
 * DÃ©clenchÃ© APRÃˆS l'ajout d'un produit.
 *
 * Pattern: actionObject{ObjectType}{Action}After
 * - ObjectType: Product, Category, Customer, Order, etc.
 * - Action: Add, Update, Delete
 *
 * @param array{object: Product} $params
 */
public function hookActionObjectProductAddAfter(array $params): void
{
    /** @var Product $product */
    $product = $params['object'];

    // Indexer le produit dans un systÃ¨me externe
    $this->getService(SearchIndexService::class)->indexProduct($product->id);

    // Invalider le cache
    $this->clearModuleCache();

    $this->log('Product added', 1, ['product_id' => $product->id]);
}
```

### actionObjectProductUpdateAfter - AprÃ¨s mise Ã  jour produit

```php
/**
 * DÃ©clenchÃ© APRÃˆS la mise Ã  jour d'un produit.
 *
 * @param array{object: Product} $params
 */
public function hookActionObjectProductUpdateAfter(array $params): void
{
    /** @var Product $product */
    $product = $params['object'];

    // RÃ©-indexer le produit
    $this->getService(SearchIndexService::class)->updateProduct($product->id);

    // Invalider les caches liÃ©s
    $this->_clearCache('*');

    $this->log('Product updated', 1, ['product_id' => $product->id]);
}
```

## ğŸ“‹ RÃ©fÃ©rence des Hooks Courants

### Display Hooks

| Hook | Emplacement | Usage |
|------|-------------|-------|
| `displayHeader` | `<head>` | CSS, meta tags |
| `displayTop` | Barre supÃ©rieure | Navigation secondaire |
| `displayNav1` | Navigation 1 | Liens (login, compte) |
| `displayNav2` | Navigation 2 | Devise, langue |
| `displayHome` | Page d'accueil | Contenu principal |
| `displayLeftColumn` | Colonne gauche | Widgets, filtres |
| `displayRightColumn` | Colonne droite | Widgets |
| `displayFooter` | Footer | Contenu pied de page |
| `displayProductAdditionalInfo` | Fiche produit | Infos supplÃ©mentaires |
| `displayProductButtons` | Fiche produit | Boutons d'action |
| `displayShoppingCart` | Panier | Infos panier |
| `displayCheckoutStep` | Tunnel de commande | Ã‰tapes custom |
| `displayOrderConfirmation` | Confirmation | Message post-commande |
| `displayCustomerAccount` | Mon compte | Liens additionnels |

### Action Hooks

| Hook | DÃ©clencheur | Usage |
|------|-------------|-------|
| `actionFrontControllerSetMedia` | Chaque page front | CSS/JS conditionnels |
| `actionValidateOrder` | Commande validÃ©e | Post-traitement commande |
| `actionCartSave` | Modification panier | Cache, calculs |
| `actionCustomerAccountAdd` | Inscription client | CRM, newsletter |
| `actionAuthentication` | Connexion client | Logging, session |
| `actionObjectProductAddAfter` | Ajout produit | Indexation, sync |
| `actionObjectProductUpdateAfter` | Modification produit | RÃ©-indexation |
| `actionObjectOrderAddAfter` | CrÃ©ation commande | Notifications |
| `actionAdminControllerSetMedia` | Page admin | Assets back-office |

## âš ï¸ Bonnes Pratiques

1. **Toujours vÃ©rifier l'activation** du module en dÃ©but de hook
2. **DÃ©lÃ©guer au service** - Pas de logique mÃ©tier dans les hooks
3. **GÃ©rer les exceptions** - Ne jamais faire planter PrestaShop
4. **Optimiser les action hooks** - Certains sont trÃ¨s frÃ©quents
5. **Utiliser le cache** - `$this->isCached()` pour les display hooks
6. **Typer les paramÃ¨tres** - Documenter avec PHPDoc
7. **Retourner '' (string vide)** - Jamais `null` pour les display hooks
