---
description: Extension Audit WEDEV - Journal d'audit et traÃ§abilitÃ©
globs: ["**/Extension/Audit/**/*.php"]
alwaysApply: false
---

# Extension Audit WEDEV

## ðŸŽ¯ Objectif

Journal d'audit pour traÃ§abilitÃ© des actions et conformitÃ© RGPD.

## ðŸ“¦ Composants

| Composant | RÃ´le |
|-----------|------|
| `AuditLogger` | Service principal de logging |
| `AuditEntry` | ReprÃ©sentation d'une entrÃ©e d'audit |
| `AuditRepository` | Persistance en base de donnÃ©es |
| `AuditableTrait` | Trait pour ajouter l'audit aux services |

## âœ… Bonnes Pratiques

### Utilisation du Trait

```php
// âœ… BON: Utiliser le trait pour simplifier
class ProductService
{
    use AuditableTrait;

    public function update(int $id, array $data): void
    {
        $product = new Product($id);
        $oldData = $this->extractData($product);

        $product->name = $data['name'];
        $product->save();

        $this->auditUpdate('Product', $id, $oldData, $this->extractData($product));
    }
}
```

### DonnÃ©es Ã  Logger

```php
// âœ… BON: DonnÃ©es essentielles seulement
$this->auditUpdate('Product', $id, [
    'name' => $old->name,
    'price' => $old->price,
    'active' => $old->active,
], [
    'name' => $new->name,
    'price' => $new->price,
    'active' => $new->active,
]);

// âŒ MAUVAIS: DonnÃ©es sensibles en clair
$this->auditUpdate('Customer', $id, [
    'password' => $old->password,  // JAMAIS!
    'credit_card' => $old->cc,     // JAMAIS!
], [...]);

// âœ… BON: Masquer les donnÃ©es sensibles
$this->auditUpdate('Customer', $id, [
    'email' => '***@' . explode('@', $old->email)[1],
    'password_changed' => true,  // Juste indiquer le changement
], [...]);
```

### Contexte Enrichi

```php
// âœ… BON: Ajouter du contexte pertinent
$this->auditExport('Order', [
    'count' => count($orders),
    'format' => 'csv',
    'filters' => [
        'date_from' => $filters['from'],
        'status' => $filters['status'],
    ],
    'file_size' => filesize($exportPath),
]);
```

## ðŸ”’ ConformitÃ© RGPD

```php
// âœ… BON: Logger les consultations de donnÃ©es personnelles
public function viewCustomerData(int $customerId): array
{
    $data = $this->repository->findById($customerId);

    $this->auditView('Customer', $customerId, [
        'fields_accessed' => ['email', 'address', 'phone'],
        'reason' => 'support_ticket_123',
    ]);

    return $data;
}

// âœ… BON: Logger les exports RGPD
public function exportCustomerData(int $customerId): string
{
    $data = $this->collectAllData($customerId);

    $this->auditExport('CustomerGDPRData', [
        'customer_id' => $customerId,
        'reason' => 'gdpr_data_request',
    ]);

    return json_encode($data);
}

// âœ… BON: Logger les suppressions (droit Ã  l'oubli)
public function deleteCustomerData(int $customerId): void
{
    $customer = new Customer($customerId);
    $data = ['email' => $customer->email, 'name' => $customer->name];

    $customer->delete();

    $this->auditDelete('Customer', $customerId, $data, [
        'reason' => 'gdpr_right_to_be_forgotten',
        'requested_by' => 'customer',
    ]);
}
```

## ðŸš« Anti-patterns

```php
// âŒ Logger trop de dÃ©tails
$this->auditView('Product', $id);  // Ã€ chaque vue de page produit = trop!

// âŒ Logger sans valeur ajoutÃ©e
$this->log('custom', 'System', null, [], [], ['debug' => true]);

// âŒ Oublier de logger les suppressions
$product->delete();  // Sans audit!
```

## ðŸ“ Recherche et Affichage

```php
// Historique d'une entitÃ©
$history = $logger->getEntityHistory('Product', 123);

// Recherche avancÃ©e
$entries = $logger->search([
    'action' => 'update',
    'entity_type' => 'Product',
    'date_from' => '2024-01-01',
], limit: 100);

// Affichage des changements
foreach ($entry->getChanges() as $field => $change) {
    echo "$field: {$change['old']} â†’ {$change['new']}";
}
```

## ðŸ§¹ Maintenance

```php
// Nettoyage automatique (CRON hebdomadaire)
$deleted = $logger->cleanup(daysToKeep: 365);

// RÃ©tention configurable
$retention = Configuration::get('MYMODULE_AUDIT_RETENTION', 365);
$logger->cleanup($retention);
```
