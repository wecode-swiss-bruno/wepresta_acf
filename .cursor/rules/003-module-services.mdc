---
description: Services Symfony et injection de d√©pendances
globs: ["config/services.yml", "src/**/*.php"]
alwaysApply: false
---

# Services et Injection de D√©pendances

## üì¶ Configuration des Services

### Structure du fichier services.yml

```yaml
# config/services.yml

services:
    # =========================================================================
    # DEFAULTS - Appliqu√©s √† tous les services sauf override
    # =========================================================================
    _defaults:
        autowire: true           # Injection automatique des d√©pendances
        autoconfigure: true      # Tags automatiques (EventSubscriber, etc.)
        public: false            # Services priv√©s par d√©faut (best practice)
        bind:                    # Variables globales injectables
            $modulePath: '%kernel.project_dir%/modules/modulestarter'
            $debug: '%kernel.debug%'

    # =========================================================================
    # AUTO-REGISTRATION - Enregistre automatiquement les classes
    # =========================================================================
    #
    # ‚ö†Ô∏è ATTENTION: Ne PAS auto-enregistrer src/Presentation/Grid/
    #    Les classes Grid ont des param√®tres non-autowirables ($dbPrefix)
    #    et doivent √™tre configur√©es EXPLICITEMENT ci-dessous.
    #

    # Application layer
    ModuleStarter\Application\:
        resource: '../src/Application/*'
        exclude:
            - '../src/Application/Form/'  # Forms configur√©s s√©par√©ment

    # Infrastructure layer
    ModuleStarter\Infrastructure\:
        resource: '../src/Infrastructure/*'
        exclude:
            - '../src/Infrastructure/Api/'  # API controllers configur√©s s√©par√©ment

    # Domain layer - Exclure car ce ne sont pas des services
    # ModuleStarter\Domain\:  # NE PAS FAIRE - entities, value objects ne sont pas des services

    # Presentation layer - UNIQUEMENT les Controllers (pas les Grids!)
    ModuleStarter\Presentation\Controller\:
        resource: '../src/Presentation/Controller/*'
        tags: ['controller.service_arguments']

    # =========================================================================
    # INFRASTRUCTURE LAYER - Impl√©mentations concr√®tes
    # =========================================================================

    # Configuration Adapter
    ModuleStarter\Infrastructure\Adapter\ConfigurationAdapter:
        public: true  # Utilis√© dans le module principal

    # Repository avec d√©pendances PrestaShop
    ModuleStarter\Infrastructure\Repository\ModuleStarterRepository:
        arguments:
            $db: '@=service("prestashop.adapter.legacy.context").getContext().database'
        public: true

    # Alias: Interface -> Impl√©mentation
    # Permet d'injecter l'interface, pas l'impl√©mentation
    ModuleStarter\Domain\Repository\ModuleStarterRepositoryInterface:
        alias: ModuleStarter\Infrastructure\Repository\ModuleStarterRepository

    # =========================================================================
    # APPLICATION LAYER - Services m√©tier
    # =========================================================================

    ModuleStarter\Application\Service\ModuleStarterService:
        arguments:
            $repository: '@ModuleStarter\Domain\Repository\ModuleStarterRepositoryInterface'
            $config: '@ModuleStarter\Infrastructure\Adapter\ConfigurationAdapter'
            $logger: '@?logger'  # ? = optionnel, null si non disponible
        public: true

    # Alias court pour faciliter l'acc√®s
    modulestarter.service:
        alias: ModuleStarter\Application\Service\ModuleStarterService
        public: true

    # =========================================================================
    # EVENT SUBSCRIBERS - √âcouteurs d'√©v√©nements
    # =========================================================================

    ModuleStarter\Infrastructure\EventSubscriber\ProductEventSubscriber:
        arguments:
            $config: '@ModuleStarter\Infrastructure\Adapter\ConfigurationAdapter'
        tags:
            - { name: kernel.event_subscriber }

    ModuleStarter\Infrastructure\EventSubscriber\OrderEventSubscriber:
        tags:
            - { name: kernel.event_subscriber }

    # =========================================================================
    # GRID FRAMEWORK - Grilles admin
    # =========================================================================
    #
    # ‚ö†Ô∏è IMPORTANT: Les classes Grid DOIVENT √™tre configur√©es EXPLICITEMENT
    #    Ne JAMAIS les inclure dans l'auto-registration car:
    #    - GridQueryBuilder a un param√®tre $dbPrefix (string) non-autowirable
    #    - GridDefinitionFactory n√©cessite un parent sp√©cifique
    #
    # Pour chaque entit√© avec un Grid, cr√©er ces 4 services:
    #

    # 1. D√©finition de la grille (h√©rite du parent abstrait)
    # ModuleStarter\Presentation\Grid\MyEntityGridDefinitionFactory:
    #     parent: 'prestashop.core.grid.definition.factory.abstract_grid_definition'
    #     public: true

    # 2. Query builder (param√®tres EXPLICITES - pas d'autowiring!)
    # ModuleStarter\Presentation\Grid\MyEntityGridQueryBuilder:
    #     arguments:
    #         $connection: '@doctrine.dbal.default_connection'
    #         $dbPrefix: '%database_prefix%'

    # 3. Data provider
    # modulestarter.myentity.grid.data_provider:
    #     class: 'PrestaShop\PrestaShop\Core\Grid\Data\Factory\DoctrineGridDataFactory'
    #     arguments:
    #         $gridQueryBuilder: '@ModuleStarter\Presentation\Grid\MyEntityGridQueryBuilder'
    #         $hookDispatcher: '@prestashop.core.hook.dispatcher'
    #         $queryParser: '@prestashop.core.grid.query.doctrine_query_parser'
    #         $gridId: 'my_entity'

    # 4. Factory de la grille
    # modulestarter.myentity.grid.factory:
    #     class: 'PrestaShop\PrestaShop\Core\Grid\GridFactory'
    #     arguments:
    #         $definitionFactory: '@ModuleStarter\Presentation\Grid\MyEntityGridDefinitionFactory'
    #         $dataFactory: '@modulestarter.myentity.grid.data_provider'
    #         $filterFormFactory: '@prestashop.core.grid.filter.form_factory'
    #         $hookDispatcher: '@prestashop.core.hook.dispatcher'

    # =========================================================================
    # FORMS - Types de formulaires
    # =========================================================================

    ModuleStarter\Application\Form\ConfigurationType:
        parent: 'form.type.translatable.aware'
        public: true
        tags:
            - { name: form.type }

    # =========================================================================
    # API - Contr√¥leurs REST
    # =========================================================================

    ModuleStarter\Infrastructure\Api\ApiController:
        arguments:
            $service: '@ModuleStarter\Application\Service\ModuleStarterService'
            $config: '@ModuleStarter\Infrastructure\Adapter\ConfigurationAdapter'
        tags:
            - { name: controller.service_arguments }
        public: true
```

## üîå Utilisation des Services

### Dans le module principal

```php
// modulestarter.php

class ModuleStarter extends Module
{
    /**
     * R√©cup√®re un service du conteneur Symfony.
     *
     * @template T of object
     * @param class-string<T> $serviceId
     * @return T|null
     */
    public function getService(string $serviceId): ?object
    {
        try {
            $container = $this->getContainer();

            if ($container === null) {
                return null;
            }

            if (!$container->has($serviceId)) {
                return null;
            }

            return $container->get($serviceId);
        } catch (\Exception $e) {
            $this->log('Service not found: ' . $serviceId, 2);
            return null;
        }
    }

    // Utilisation dans un hook
    public function hookDisplayHome(array $params): string
    {
        $service = $this->getService(ModuleStarterService::class);

        if ($service === null) {
            return '';
        }

        $items = $service->getActiveItems();
        // ...
    }
}
```

### Dans un contr√¥leur Symfony

```php
// src/Presentation/Controller/Admin/ConfigurationController.php

use ModuleStarter\Application\Service\ModuleStarterService;
use Symfony\Component\HttpFoundation\Response;

class ConfigurationController extends FrameworkBundleAdminController
{
    // Injection via constructeur (recommand√©)
    public function __construct(
        private readonly ModuleStarterService $service
    ) {
    }

    public function indexAction(): Response
    {
        $items = $this->service->getActiveItems();
        // ...
    }

    // OU injection via param√®tre de m√©thode
    public function createAction(
        Request $request,
        ModuleStarterService $service  // Inject√© automatiquement
    ): Response {
        // ...
    }
}
```

### Dans un Event Subscriber

```php
// src/Infrastructure/EventSubscriber/ProductEventSubscriber.php

use ModuleStarter\Infrastructure\Adapter\ConfigurationAdapter;
use Symfony\Component\EventDispatcher\EventSubscriberInterface;

final class ProductEventSubscriber implements EventSubscriberInterface
{
    public function __construct(
        private readonly ConfigurationAdapter $config
    ) {
    }

    public static function getSubscribedEvents(): array
    {
        return [
            'PrestaShop\PrestaShop\Core\Domain\Product\Command\AddProductCommand' => 'onProductAdd',
        ];
    }

    public function onProductAdd(object $event): void
    {
        if (!$this->config->getBool('MODULESTARTER_ACTIVE')) {
            return;
        }
        // ...
    }
}
```

## üè∑Ô∏è Tags de Services

### Tags courants

```yaml
services:
    # Contr√¥leur avec injection d'arguments
    MyController:
        tags:
            - { name: controller.service_arguments }

    # Event Subscriber Symfony
    MyEventSubscriber:
        tags:
            - { name: kernel.event_subscriber }

    # Form Type
    MyFormType:
        tags:
            - { name: form.type }

    # Twig Extension
    MyTwigExtension:
        tags:
            - { name: twig.extension }

    # Console Command
    MyCommand:
        tags:
            - { name: console.command }
```

## üîó Services PrestaShop Utiles

```yaml
# Services PrestaShop disponibles pour injection

services:
    MyService:
        arguments:
            # Base de donn√©es
            $db: '@=service("prestashop.adapter.legacy.context").getContext().database'

            # Contexte (shop, langue, devise)
            $context: '@prestashop.adapter.legacy.context'

            # Configuration
            $configuration: '@prestashop.adapter.legacy.configuration'

            # Connexion Doctrine DBAL
            $connection: '@doctrine.dbal.default_connection'

            # Entity Manager Doctrine
            $entityManager: '@doctrine.orm.entity_manager'

            # Traducteur
            $translator: '@translator'

            # Logger
            $logger: '@logger'
            # ou optionnel:
            $logger: '@?logger'

            # Router
            $router: '@router'

            # Event Dispatcher
            $eventDispatcher: '@event_dispatcher'

            # Pr√©fixe de table
            $dbPrefix: '%database_prefix%'

            # Mode debug
            $debug: '%kernel.debug%'

            # R√©pertoire projet
            $projectDir: '%kernel.project_dir%'
```

## ‚öôÔ∏è Patterns Avanc√©s

### Factory Service

```yaml
# Pour cr√©er des instances √† la demande
services:
    modulestarter.item.factory:
        class: ModuleStarter\Application\Factory\ItemFactory
        arguments:
            $repository: '@ModuleStarter\Domain\Repository\ModuleStarterRepositoryInterface'
```

### Service avec m√©thode factory

```yaml
services:
    # Cr√©er un service via une factory
    modulestarter.special_service:
        class: ModuleStarter\Application\Service\SpecialService
        factory: ['@modulestarter.service_factory', 'create']
        arguments:
            - 'special_config'
```

### Service d√©cor√©

```yaml
services:
    # D√©corer un service existant
    ModuleStarter\Infrastructure\Decorator\LoggingRepository:
        decorates: ModuleStarter\Domain\Repository\ModuleStarterRepositoryInterface
        arguments:
            $inner: '@.inner'
            $logger: '@logger'
```

### Lazy Loading

```yaml
services:
    # Service charg√© uniquement quand utilis√©
    ModuleStarter\Application\Service\HeavyService:
        lazy: true
```

## ‚úÖ Bonnes Pratiques

1. **Injecter les interfaces**, pas les impl√©mentations
2. **Services priv√©s** par d√©faut (`public: false`)
3. **Autowiring** pour simplifier la configuration
4. **Tags autoconfigure** pour les subscribers, forms, etc.
5. **Services stateless** - pas d'√©tat entre les appels
6. **Constructeurs courts** - max 5-6 d√©pendances
7. **Logger optionnel** - `@?logger` pour √©viter les erreurs
