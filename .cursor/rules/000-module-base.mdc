---
description: RÃ¨gles de base du module PrestaShop - Architecture et conventions
globs: ["**/*.php", "**/*.js", "**/*.scss", "**/*.tpl", "**/*.twig"]
alwaysApply: true
---

# Module PrestaShop - RÃ¨gles de Base

## âš ï¸ IMPORTANT - Conventions de nommage

`modulestarter` / `ModuleStarter` est le nom du **master-module template**.
Lors de la gÃ©nÃ©ration d'un nouveau module avec `wedev ps module <nom>`, toutes les occurrences sont automatiquement remplacÃ©es :

| Template | Exemple gÃ©nÃ©rÃ© |
|----------|---------------|
| `modulestarter` | `mon_module` |
| `ModuleStarter` | `MonModule` |
| `MODULESTARTER` | `MON_MODULE` |
| `Modulestarter` | `Monmodule` |

**Dans ces rÃ¨gles**, lire `modulestarter` comme le nom de votre module actuel.

## ğŸ¯ IdentitÃ© du Module

Ce module suit l'architecture **Clean Architecture** pour PrestaShop 8.x/9.x:
- **Application Layer**: Use cases, services, forms
- **Domain Layer**: Entities, repository interfaces, value objects
- **Infrastructure Layer**: ImplÃ©mentations concrÃ¨tes, adapters
- **Presentation Layer**: Controllers, grids, templates

## ğŸ“ Structure du Projet

```
modulestarter/
â”œâ”€â”€ modulestarter.php           # Point d'entrÃ©e (hooks, install/uninstall)
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ routes.yml              # Routes Symfony admin
â”‚   â””â”€â”€ services.yml            # Injection de dÃ©pendances
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ Wedev/                  # âš ï¸ Framework WEDEV - NE PAS MODIFIER
â”‚   â”‚   â”œâ”€â”€ Core/               # Adapters, Traits, Repository abstrait
â”‚   â”‚   â””â”€â”€ Extension/          # Extensions (UI, EntityPicker, Http...)
â”‚   â”‚
â”‚   â”œâ”€â”€ _example/               # ğŸ“ Exemples - Ã€ copier puis supprimer
â”‚   â”‚   â””â”€â”€ ...                 # Templates d'entitÃ©s, services, controllers
â”‚   â”‚
â”‚   â”œâ”€â”€ Application/            # ğŸ‘¤ VOTRE CODE - Logique applicative
â”‚   â”‚   â”œâ”€â”€ Command/            # Write operations (CQRS)
â”‚   â”‚   â”œâ”€â”€ Query/              # Read operations (CQRS)
â”‚   â”‚   â”œâ”€â”€ Form/               # Form Types Symfony
â”‚   â”‚   â”œâ”€â”€ Installer/          # Install/Uninstall logic
â”‚   â”‚   â””â”€â”€ Service/            # Business services
â”‚   â”œâ”€â”€ Domain/                 # ğŸ‘¤ VOTRE CODE - Logique mÃ©tier pure
â”‚   â”‚   â”œâ”€â”€ Entity/             # EntitÃ©s du domaine
â”‚   â”‚   â”œâ”€â”€ Repository/         # Interfaces repository
â”‚   â”‚   â”œâ”€â”€ ValueObject/        # Value objects immutables
â”‚   â”‚   â”œâ”€â”€ Event/              # Domain events
â”‚   â”‚   â””â”€â”€ Exception/          # Exceptions mÃ©tier
â”‚   â”œâ”€â”€ Infrastructure/         # ğŸ‘¤ VOTRE CODE - ImplÃ©mentations
â”‚   â”‚   â”œâ”€â”€ Adapter/            # Adapters (Configuration, etc.)
â”‚   â”‚   â”œâ”€â”€ Repository/         # ImplÃ©mentations repository
â”‚   â”‚   â”œâ”€â”€ EventSubscriber/    # Event subscribers Symfony
â”‚   â”‚   â””â”€â”€ Api/                # ContrÃ´leurs API REST
â”‚   â””â”€â”€ Presentation/           # ğŸ‘¤ VOTRE CODE - Interface utilisateur
â”‚       â”œâ”€â”€ Controller/         # ContrÃ´leurs admin Symfony
â”‚       â””â”€â”€ Grid/               # Grid Framework PrestaShop
â”œâ”€â”€ controllers/
â”‚   â””â”€â”€ front/                  # ContrÃ´leurs front legacy
â”œâ”€â”€ views/
â”‚   â”œâ”€â”€ css/, js/               # Assets compilÃ©s
â”‚   â”œâ”€â”€ dist/                   # Build Webpack
â”‚   â””â”€â”€ templates/
â”‚       â”œâ”€â”€ admin/              # Templates Twig (back-office)
â”‚       â”œâ”€â”€ front/              # Templates Smarty (front-office)
â”‚       â””â”€â”€ hook/               # Templates des hooks
â”œâ”€â”€ _dev/                       # Sources dÃ©veloppement
â”‚   â”œâ”€â”€ js/                     # JavaScript ES6+
â”‚   â”œâ”€â”€ scss/                   # Styles SCSS
â”‚   â””â”€â”€ images/                 # Images sources
â”œâ”€â”€ sql/                        # Scripts SQL
â”œâ”€â”€ tests/                      # Tests PHPUnit
â””â”€â”€ translations/               # Fichiers de traduction
```

### SÃ©paration des responsabilitÃ©s

| Dossier | ResponsabilitÃ© | Modifiable |
|---------|----------------|------------|
| `Wedev/` | Framework WEDEV (Core + Extensions) | âŒ Non |
| `_example/` | Code d'exemple Ã  copier | Supprimer aprÃ¨s usage |
| `Application/` | Votre logique applicative | âœ… Oui |
| `Domain/` | Votre logique mÃ©tier | âœ… Oui |
| `Infrastructure/` | Vos implÃ©mentations | âœ… Oui |
| `Presentation/` | Vos contrÃ´leurs/grids | âœ… Oui |

## âœ… Conventions de Nommage

| Type | Convention | Exemple |
|------|------------|---------|
| Classes PHP | PascalCase | `ModuleStarterService` |
| MÃ©thodes | camelCase | `getActiveItems()` |
| Variables | camelCase | `$itemCount` |
| Constantes | UPPER_SNAKE | `DEFAULT_CONFIG` |
| Fichiers PHP | PascalCase | `ConfigurationAdapter.php` |
| Services | snake_case | `modulestarter.service` |
| Routes | snake_case | `modulestarter_configuration` |
| Config keys | UPPER_SNAKE | `MODULESTARTER_ACTIVE` |
| Hooks | camelCase | `hookDisplayHome` |
| Templates Smarty | kebab-case | `product-info.tpl` |
| Templates Twig | kebab-case | `configuration.html.twig` |
| CSS classes | BEM kebab-case | `.modulestarter-item__title` |

## ğŸ”’ Standards Obligatoires

### PHP

```php
<?php
// TOUJOURS en haut de chaque fichier PHP
declare(strict_types=1);

// VÃ©rification PrestaShop (fichiers accessibles publiquement)
if (!defined('_PS_VERSION_')) {
    exit;
}

// Typage strict sur TOUTES les mÃ©thodes
public function getItem(int $id): ?ModuleStarterEntity
{
    // ...
}

// Properties typÃ©es (PHP 8.1+)
private readonly ConfigurationAdapter $config;

// Constructor promotion
public function __construct(
    private readonly ModuleStarterRepositoryInterface $repository,
    private readonly ConfigurationAdapter $config
) {
}
```

### Imports

```php
// âœ… BON: Imports triÃ©s, groupÃ©s logiquement
use ModuleStarter\Domain\Entity\ModuleStarterEntity;
use ModuleStarter\Domain\Repository\ModuleStarterRepositoryInterface;
use ModuleStarter\Infrastructure\Adapter\ConfigurationAdapter;
use PrestaShop\PrestaShop\Core\Grid\GridFactory;
use Symfony\Component\HttpFoundation\Request;

// âŒ MAUVAIS: Imports en dÃ©sordre, non groupÃ©s
use Symfony\Component\HttpFoundation\Request;
use ModuleStarter\Domain\Entity\ModuleStarterEntity;
use PrestaShop\PrestaShop\Core\Grid\GridFactory;
```

### Documentation

```php
/**
 * Description courte de la classe.
 *
 * Description longue optionnelle expliquant le contexte,
 * les responsabilitÃ©s et les dÃ©pendances.
 */
final class ModuleStarterService
{
    /**
     * RÃ©cupÃ¨re les Ã©lÃ©ments actifs pour le front-office.
     *
     * @return ModuleStarterEntity[] Liste des entitÃ©s actives triÃ©es par position
     *
     * @throws ServiceNotAvailableException Si le service est dÃ©sactivÃ©
     */
    public function getActiveItems(): array
    {
        // ...
    }
}
```

## ğŸš« Anti-patterns Ã  Ã‰viter

### Ne JAMAIS faire

```php
// âŒ AccÃ¨s direct Ã  la base de donnÃ©es dans le module principal
Db::getInstance()->execute("SELECT * FROM ...");

// âŒ Configuration hardcodÃ©e
$apiKey = 'sk_live_xxx';

// âŒ Superglobales directes
$id = $_GET['id'];

// âŒ echo/print dans les hooks
public function hookDisplayHome($params) {
    echo '<div>Hello</div>'; // âŒ
}

// âŒ SQL sans escape
$sql = "SELECT * FROM table WHERE name = '$name'"; // SQL INJECTION!

// âŒ Mixed concerns dans le module principal
public function hookDisplayHome($params) {
    // âŒ Logique mÃ©tier dans le hook
    $products = Db::getInstance()->executeS("...");
    $filtered = array_filter($products, ...);
    // ...
}
```

### Toujours faire

```php
// âœ… Utiliser le repository
$items = $this->repository->findActive();

// âœ… Configuration via adapter
$apiKey = $this->config->get('MODULESTARTER_API_KEY');

// âœ… Utiliser Tools
$id = (int) Tools::getValue('id');

// âœ… Retourner le HTML dans les hooks
public function hookDisplayHome(array $params): string {
    return $this->fetch('module:modulestarter/views/templates/hook/home.tpl');
}

// âœ… SQL sÃ©curisÃ© via pSQL
$sql = "SELECT * FROM table WHERE name = '" . pSQL($name) . "'";

// âœ… DÃ©lÃ©guer au service
public function hookDisplayHome(array $params): string {
    $items = $this->getService(ModuleStarterService::class)->getActiveItems();
    $this->context->smarty->assign(['items' => $items]);
    return $this->fetch('...');
}
```

## ğŸ”„ Workflow de DÃ©veloppement

1. **CrÃ©er l'entitÃ©** dans `Domain/Entity/`
2. **DÃ©finir l'interface** repository dans `Domain/Repository/`
3. **ImplÃ©menter** le repository dans `Infrastructure/Repository/`
4. **CrÃ©er le service** dans `Application/Service/`
5. **Enregistrer** dans `config/services.yml`
6. **CrÃ©er le contrÃ´leur** si nÃ©cessaire
7. **Ajouter les templates**
8. **Ã‰crire les tests**

## âš ï¸ PiÃ¨ges Courants Ã  Ã‰viter

### Grid Framework (CRITIQUE)

```yaml
# âŒ NE JAMAIS auto-enregistrer les Grids - cause erreur autowiring
ModuleStarter\Presentation\:
    resource: '../src/Presentation/*'

# âœ… TOUJOURS sÃ©parer Controllers et Grids
ModuleStarter\Presentation\Controller\:
    resource: '../src/Presentation/Controller/*'
    tags: ['controller.service_arguments']

# Les Grids doivent Ãªtre configurÃ©s EXPLICITEMENT avec $dbPrefix
```

**Voir rÃ¨gle `019-module-grids.mdc` pour la configuration complÃ¨te.**

### Autres piÃ¨ges

| PiÃ¨ge | Solution |
|-------|----------|
| Grid dans auto-registration | Configurer explicitement avec `$dbPrefix: '%database_prefix%'` |
| Forms dans auto-registration | Configurer avec `parent: 'form.type.translatable.aware'` |
| Service non trouvÃ© | VÃ©rifier `public: true` pour les services utilisÃ©s hors container |
| Erreur traduction | Utiliser `Modules.Modulestarter.Admin` comme domaine |
| Route `admin_domain` introuvable | Utiliser `#[AdminSecurity(..., redirectRoute: 'admin_dashboard')]` (Attribute PHP 8) |
| Annotations `@Route` conflits | PrÃ©fÃ©rer `config/routes.yml` aux annotations |
| **`buildSearchCriteriaFromRequest` n'existe pas (PS9)** | Construire `SearchCriteria` manuellement (voir ci-dessous) |

### âš ï¸ SearchCriteria dans PrestaShop 9 (CRITIQUE)

La mÃ©thode `buildSearchCriteriaFromRequest` **n'existe pas** dans PrestaShop 9:

```php
// âŒ ERREUR - Cette mÃ©thode n'existe pas dans PS9
$searchCriteria = $this->buildSearchCriteriaFromRequest($request, 'myentity');
// UndefinedMethodError: Attempted to call an undefined method

// âœ… SOLUTION - Construire manuellement
use PrestaShop\PrestaShop\Core\Grid\Search\SearchCriteria;

$filters = $request->query->all(MyEntityGridDefinitionFactory::GRID_ID) ?: [];
$searchCriteria = new SearchCriteria(
    $filters['filters'] ?? [],
    $filters['orderBy'] ?? 'id_myentity',
    $filters['sortOrder'] ?? 'desc',
    (int) ($filters['offset'] ?? 0),
    (int) ($filters['limit'] ?? 10)
);
$grid = $this->gridFactory->getGrid($searchCriteria);
```

**Voir rÃ¨gle `019-module-grids.mdc` pour l'exemple complet.**

## ğŸ“‹ Checklist avant Commit

- [ ] `composer cs-check` passe
- [ ] `composer phpstan` passe
- [ ] `composer phpunit` passe
- [ ] Pas de `var_dump`, `die()`, `dd()`
- [ ] Tous les textes utilisent `$this->trans()`
- [ ] Les nouvelles configs sont dans `DEFAULT_CONFIG`
- [ ] Les nouveaux hooks sont dans `HOOKS`
- [ ] Le SQL utilise `pSQL()` ou des paramÃ¨tres bindÃ©s
- [ ] **Grids configurÃ©s EXPLICITEMENT** (pas d'auto-registration)
