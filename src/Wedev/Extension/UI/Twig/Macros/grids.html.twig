{#
 # =============================================================================
 # WEDEV UI - Macros Twig pour Grilles PrestaShop 9
 # =============================================================================
 # Utilisation: {% import '@WedevUI/Macros/grids.html.twig' as grids %}
 #
 # Ces macros facilitent l'intégration avec le Grid Framework PrestaShop.
 # =============================================================================
 #}

{# -----------------------------------------------------------------------------
 # Grid Container - Conteneur principal de grille
 # Usage: {{ grids.container(gridId, gridContent) }}
 # -------------------------------------------------------------------------- #}
{% macro container(gridId, content, title, icon) %}
<div class="card" id="{{ gridId }}-container">
    {% if title %}
    <div class="card-header">
        <h3 class="card-header-title">
            {% if icon %}<i class="material-icons mr-2">{{ icon }}</i>{% endif %}
            {{ title }}
        </h3>
    </div>
    {% endif %}
    <div class="card-body p-0">
        {{ content|raw }}
    </div>
</div>
{% endmacro %}

{# -----------------------------------------------------------------------------
 # Grid Header Actions - Actions en haut de grille
 # Usage: {{ grids.header_actions(searchForm, bulkActions, addButton) }}
 # -------------------------------------------------------------------------- #}
{% macro header_actions(searchForm, addButton, bulkActions) %}
<div class="card-header d-flex justify-content-between align-items-center">
    <div class="d-flex align-items-center">
        {% if searchForm %}
            {{ searchForm|raw }}
        {% endif %}
    </div>
    <div class="d-flex align-items-center">
        {% if bulkActions %}
            <div class="dropdown mr-2">
                <button class="btn btn-secondary dropdown-toggle" type="button" data-toggle="dropdown" disabled>
                    <i class="material-icons">checklist</i>
                    Bulk actions
                </button>
                <div class="dropdown-menu">
                    {{ bulkActions|raw }}
                </div>
            </div>
        {% endif %}
        {% if addButton %}
            {{ addButton|raw }}
        {% endif %}
    </div>
</div>
{% endmacro %}

{# -----------------------------------------------------------------------------
 # Grid Actions Column - Colonne d'actions pour une ligne
 # Usage: {{ grids.row_actions(editHref, deleteHref, extraActions) }}
 # -------------------------------------------------------------------------- #}
{% macro row_actions(editHref, deleteHref, extraActions, id) %}
<div class="btn-group" role="group">
    {% if editHref %}
        <a href="{{ editHref }}" class="btn btn-sm btn-outline-secondary" title="Edit">
            <i class="material-icons">edit</i>
        </a>
    {% endif %}

    {% if extraActions %}
        {% for action in extraActions %}
            <a href="{{ action.href }}"
               class="btn btn-sm btn-outline-{{ action.variant|default('secondary') }}"
               title="{{ action.label }}"
               {{ action.attrs|default('')|raw }}>
                {% if action.icon %}<i class="material-icons">{{ action.icon }}</i>{% endif %}
                {% if action.showLabel|default(false) %} {{ action.label }}{% endif %}
            </a>
        {% endfor %}
    {% endif %}

    {% if deleteHref %}
        <button type="button"
                class="btn btn-sm btn-outline-danger"
                title="Delete"
                x-data
                @click="if(confirm('Are you sure you want to delete this item?')) { window.location.href = '{{ deleteHref }}' }">
            <i class="material-icons">delete</i>
        </button>
    {% endif %}
</div>
{% endmacro %}

{# -----------------------------------------------------------------------------
 # Position Column - Colonne de position avec drag handle
 # Usage: {{ grids.position_column(item.position, item.id) }}
 # -------------------------------------------------------------------------- #}
{% macro position_column(position, id) %}
<div class="d-flex align-items-center">
    <span class="drag-handle mr-2" style="cursor: grab;" data-id="{{ id }}">
        <i class="material-icons text-muted">drag_indicator</i>
    </span>
    <span class="position-value">{{ position }}</span>
</div>
{% endmacro %}

{# -----------------------------------------------------------------------------
 # Image Column - Colonne avec miniature
 # Usage: {{ grids.image_column(imageUrl, altText, size) }}
 # -------------------------------------------------------------------------- #}
{% macro image_column(imageUrl, altText, size) %}
{% set size = size|default(50) %}
{% if imageUrl %}
    <img src="{{ imageUrl }}"
         alt="{{ altText|default('Image') }}"
         class="img-thumbnail"
         style="width: {{ size }}px; height: {{ size }}px; object-fit: cover;">
{% else %}
    <div class="d-flex align-items-center justify-content-center bg-light"
         style="width: {{ size }}px; height: {{ size }}px; border-radius: 4px;">
        <i class="material-icons text-muted">image</i>
    </div>
{% endif %}
{% endmacro %}

{# -----------------------------------------------------------------------------
 # Toggle Column - Colonne avec interrupteur
 # Usage: {{ grids.toggle_column(isActive, toggleUrl, id) }}
 # -------------------------------------------------------------------------- #}
{% macro toggle_column(isActive, toggleUrl, id) %}
<div class="custom-control custom-switch"
     x-data="{ active: {{ isActive ? 'true' : 'false' }}, loading: false }"
     x-on:change="
        loading = true;
        fetch('{{ toggleUrl }}', { method: 'POST', headers: {'X-Requested-With': 'XMLHttpRequest'} })
            .then(r => r.json())
            .then(data => { active = data.active; loading = false; })
            .catch(() => { loading = false; });
     ">
    <input type="checkbox"
           class="custom-control-input"
           id="toggle-{{ id }}"
           :checked="active"
           :disabled="loading">
    <label class="custom-control-label" for="toggle-{{ id }}"></label>
</div>
{% endmacro %}

{# -----------------------------------------------------------------------------
 # Pagination - Navigation de pagination
 # Usage: {{ grids.pagination(currentPage, totalPages, baseUrl) }}
 # -------------------------------------------------------------------------- #}
{% macro pagination(currentPage, totalPages, baseUrl) %}
{% if totalPages > 1 %}
<nav aria-label="Grid pagination">
    <ul class="pagination pagination-sm justify-content-center mb-0">
        {# Previous #}
        <li class="page-item{{ currentPage <= 1 ? ' disabled' : '' }}">
            <a class="page-link" href="{{ baseUrl }}?page={{ currentPage - 1 }}" aria-label="Previous">
                <span aria-hidden="true">&laquo;</span>
            </a>
        </li>

        {# Pages #}
        {% for page in 1..totalPages %}
            {% if page == 1 or page == totalPages or (page >= currentPage - 2 and page <= currentPage + 2) %}
                <li class="page-item{{ page == currentPage ? ' active' : '' }}">
                    <a class="page-link" href="{{ baseUrl }}?page={{ page }}">{{ page }}</a>
                </li>
            {% elseif page == currentPage - 3 or page == currentPage + 3 %}
                <li class="page-item disabled">
                    <span class="page-link">...</span>
                </li>
            {% endif %}
        {% endfor %}

        {# Next #}
        <li class="page-item{{ currentPage >= totalPages ? ' disabled' : '' }}">
            <a class="page-link" href="{{ baseUrl }}?page={{ currentPage + 1 }}" aria-label="Next">
                <span aria-hidden="true">&raquo;</span>
            </a>
        </li>
    </ul>
</nav>
{% endif %}
{% endmacro %}

{# -----------------------------------------------------------------------------
 # Items Per Page - Sélecteur du nombre d'éléments par page
 # Usage: {{ grids.items_per_page(currentLimit, baseUrl) }}
 # -------------------------------------------------------------------------- #}
{% macro items_per_page(currentLimit, baseUrl, options) %}
{% set options = options|default([10, 25, 50, 100]) %}
<div class="d-flex align-items-center">
    <label class="mb-0 mr-2 text-muted small">Show:</label>
    <select class="custom-select custom-select-sm" style="width: auto;" onchange="window.location.href = '{{ baseUrl }}?limit=' + this.value">
        {% for option in options %}
            <option value="{{ option }}"{{ option == currentLimit ? ' selected' : '' }}>{{ option }}</option>
        {% endfor %}
    </select>
</div>
{% endmacro %}

{# -----------------------------------------------------------------------------
 # Bulk Checkbox - Checkbox pour sélection multiple
 # Usage: {{ grids.bulk_checkbox(id, isHeader) }}
 # -------------------------------------------------------------------------- #}
{% macro bulk_checkbox(id, isHeader) %}
{% if isHeader|default(false) %}
    <div class="custom-control custom-checkbox">
        <input type="checkbox"
               class="custom-control-input"
               id="bulk-select-all"
               x-data
               @change="document.querySelectorAll('.bulk-checkbox').forEach(cb => cb.checked = $el.checked)">
        <label class="custom-control-label" for="bulk-select-all"></label>
    </div>
{% else %}
    <div class="custom-control custom-checkbox">
        <input type="checkbox"
               class="custom-control-input bulk-checkbox"
               id="bulk-{{ id }}"
               name="bulk_ids[]"
               value="{{ id }}">
        <label class="custom-control-label" for="bulk-{{ id }}"></label>
    </div>
{% endif %}
{% endmacro %}

{# -----------------------------------------------------------------------------
 # Sort Header - En-tête de colonne triable
 # Usage: {{ grids.sort_header('Name', 'name', currentSort, currentOrder, baseUrl) }}
 # -------------------------------------------------------------------------- #}
{% macro sort_header(label, field, currentSort, currentOrder, baseUrl) %}
{% set isActive = currentSort == field %}
{% set nextOrder = (isActive and currentOrder == 'asc') ? 'desc' : 'asc' %}
<a href="{{ baseUrl }}?sort={{ field }}&order={{ nextOrder }}"
   class="text-dark text-decoration-none d-flex align-items-center">
    {{ label }}
    {% if isActive %}
        <i class="material-icons ml-1" style="font-size: 16px;">
            {{ currentOrder == 'asc' ? 'arrow_upward' : 'arrow_downward' }}
        </i>
    {% endif %}
</a>
{% endmacro %}

{# -----------------------------------------------------------------------------
 # Filter Form - Formulaire de filtres
 # Usage: {{ grids.filter_form(filters, submitUrl) }}
 # -------------------------------------------------------------------------- #}
{% macro filter_form(filters, submitUrl, resetUrl) %}
<form action="{{ submitUrl }}" method="GET" class="form-inline">
    {% for filter in filters %}
        <div class="form-group mr-2 mb-2">
            {% if filter.type == 'text' %}
                <input type="text"
                       class="form-control form-control-sm"
                       name="{{ filter.name }}"
                       value="{{ filter.value|default('') }}"
                       placeholder="{{ filter.placeholder|default(filter.label) }}">
            {% elseif filter.type == 'select' %}
                <select class="custom-select custom-select-sm" name="{{ filter.name }}">
                    <option value="">{{ filter.placeholder|default('All ' ~ filter.label) }}</option>
                    {% for option in filter.options %}
                        <option value="{{ option.value }}"{{ option.value == filter.value ? ' selected' : '' }}>
                            {{ option.label }}
                        </option>
                    {% endfor %}
                </select>
            {% endif %}
        </div>
    {% endfor %}

    <button type="submit" class="btn btn-sm btn-primary mr-2 mb-2">
        <i class="material-icons">search</i>
        Filter
    </button>

    {% if resetUrl %}
        <a href="{{ resetUrl }}" class="btn btn-sm btn-outline-secondary mb-2">
            <i class="material-icons">clear</i>
            Reset
        </a>
    {% endif %}
</form>
{% endmacro %}
