{# **
 * WePresta ACF - Configuration Page Template
 *
 * @var FormView configurationForm
 * @var string moduleVersion
 * @var bool syncEnabled
 * @var string syncPath
 * @var array|null syncStatus
 * @var array fieldTypes
 * @var array discoveryPaths
 * #}

{% extends '@PrestaShop/Admin/layout.html.twig' %}

{# Import WEDEV UI Macros via relative path #}
{% import '@Modules/wepresta_acf/src/Wedev/Extension/UI/Twig/Macros/admin.html.twig' as ui %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="{{ asset('../modules/wepresta_acf/views/dist/admin.css') }}">
{% endblock %}

{# Add Save button to header toolbar #}
{% block header_toolbar_btn %}
    <div class="toolbar-icons">
        <div class="wrapper">
            <span class="badge badge-secondary mr-2" style="font-size: 11px; padding: 6px 10px;">v{{ moduleVersion }}</span>
            <button type="submit" form="configuration-form" class="btn btn-primary">
                <i class="material-icons">save</i>
                {{ 'Save'|trans({}, 'Admin.Actions') }}
            </button>
        </div>
    </div>
{% endblock %}

{% block content %}
{# Include WEDEV UI Partials #}
{% include '@Modules/wepresta_acf/src/Wedev/Extension/UI/Templates/admin/_partials/confirm-modal.html.twig' %}
{% include '@Modules/wepresta_acf/src/Wedev/Extension/UI/Templates/admin/_partials/toasts.html.twig' %}

<div class="wepresta_acf-config">
    {# Tabs Navigation #}
    <ul class="nav nav-tabs mb-4" id="configTabs" role="tablist">
        <li class="nav-item">
            <a class="nav-link active" id="general-tab" data-toggle="tab" href="#general" role="tab">
                {{ ui.icon('settings', 'sm') }}
                {{ 'General'|trans({}, 'Admin.Global') }}
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="sync-tab" data-toggle="tab" href="#sync" role="tab">
                {{ ui.icon('sync', 'sm') }}
                {{ 'Sync'|trans({}, 'Modules.Weprestaacf.Admin') }}
                {% if syncStatus and syncStatus.need_push > 0 %}
                    <span class="badge badge-warning ml-1">{{ syncStatus.need_push }}</span>
                {% endif %}
                {% if syncStatus and syncStatus.need_pull > 0 %}
                    <span class="badge badge-info ml-1">{{ syncStatus.need_pull }}</span>
                {% endif %}
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="fieldtypes-tab" data-toggle="tab" href="#fieldtypes" role="tab">
                {{ ui.icon('category', 'sm') }}
                {{ 'Field Types'|trans({}, 'Modules.Weprestaacf.Admin') }}
                <span class="badge badge-secondary ml-1">{{ fieldTypes|length }}</span>
            </a>
        </li>
    </ul>

    {# Tab Content #}
    {{ form_start(configurationForm, {'attr': {'id': 'configuration-form'}}) }}
    <div class="tab-content" id="configTabsContent">

        {# ========== General Tab ========== #}
        <div class="tab-pane fade show active" id="general" role="tabpanel">
            <div class="row">
                <div class="col-xl-8">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-header-title">
                                {{ ui.icon('tune', 'md') }}
                                {{ 'General Settings'|trans({}, 'Modules.Weprestaacf.Admin') }}
                            </h3>
                        </div>
                        <div class="card-body">
                            <div class="form-group row">
                                {{ form_label(configurationForm.active) }}
                                <div class="col-sm">
                                    {{ form_widget(configurationForm.active) }}
                                    {{ form_errors(configurationForm.active) }}
                                </div>
                            </div>

                            <div class="form-group row">
                                {{ form_label(configurationForm.debug) }}
                                <div class="col-sm">
                                    {{ form_widget(configurationForm.debug) }}
                                    {{ form_errors(configurationForm.debug) }}
                                </div>
                            </div>

                            <div class="form-group row">
                                {{ form_label(configurationForm.max_file_size) }}
                                <div class="col-sm">
                                    <div class="input-group">
                                        {{ form_widget(configurationForm.max_file_size) }}
                                        <div class="input-group-append">
                                            <span class="input-group-text">MB</span>
                                        </div>
                                    </div>
                                    {{ form_errors(configurationForm.max_file_size) }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-xl-4">
                    {# Quick Links #}
                    <div class="card mb-3">
                        <div class="card-header">
                            <h3 class="card-header-title">
                                {{ ui.icon('link', 'md') }}
                                {{ 'Quick Links'|trans({}, 'Modules.Weprestaacf.Admin') }}
                            </h3>
                        </div>
                        <div class="card-body">
                            <div class="list-group">
                                <a href="{{ path('wepresta_acf_builder') }}" class="list-group-item list-group-item-action">
                                    {{ ui.icon('view_list', 'sm') }}
                                    {{ 'Manage Field Groups'|trans({}, 'Modules.Weprestaacf.Admin') }}
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {# ========== Sync Tab ========== #}
        <div class="tab-pane fade" id="sync" role="tabpanel">
            <div class="row">
                <div class="col-xl-8">
                    {# Sync Settings Card #}
                    <div class="card mb-4">
                        <div class="card-header">
                            <h3 class="card-header-title">
                                {{ ui.icon('settings', 'md') }}
                                {{ 'Sync Settings'|trans({}, 'Modules.Weprestaacf.Admin') }}
                            </h3>
                        </div>
                        <div class="card-body">
                            <div class="form-group row">
                                {{ form_label(configurationForm.sync_enabled) }}
                                <div class="col-sm">
                                    {{ form_widget(configurationForm.sync_enabled) }}
                                    {{ form_errors(configurationForm.sync_enabled) }}
                                </div>
                            </div>

                            <div class="form-group row">
                                {{ form_label(configurationForm.auto_sync_on_save) }}
                                <div class="col-sm">
                                    {{ form_widget(configurationForm.auto_sync_on_save) }}
                                    {{ form_errors(configurationForm.auto_sync_on_save) }}
                                </div>
                            </div>

                            <div class="form-group row">
                                {{ form_label(configurationForm.sync_on_install) }}
                                <div class="col-sm">
                                    {{ form_widget(configurationForm.sync_on_install) }}
                                    {{ form_errors(configurationForm.sync_on_install) }}
                                </div>
                            </div>

                            <hr>

                            <div class="form-group row">
                                {{ form_label(configurationForm.sync_path_type) }}
                                <div class="col-sm">
                                    {{ form_widget(configurationForm.sync_path_type, {'attr': {'id': 'sync_path_type'}}) }}
                                    {{ form_errors(configurationForm.sync_path_type) }}
                                </div>
                            </div>

                            <div class="form-group row" id="custom_path_group" style="display: none;">
                                {{ form_label(configurationForm.sync_custom_path) }}
                                <div class="col-sm">
                                    {{ form_widget(configurationForm.sync_custom_path) }}
                                    {{ form_errors(configurationForm.sync_custom_path) }}
                                </div>
                            </div>

                            {% if syncPath %}
                            <div class="alert alert-info mb-0">
                                <strong>{{ 'Current sync path:'|trans({}, 'Modules.Weprestaacf.Admin') }}</strong>
                                <code>{{ syncPath }}</code>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    {# Sync Status Card #}
                    {% if syncEnabled and syncStatus %}
                    <div class="card mb-4">
                        <div class="card-header">
                            <h3 class="card-header-title">
                                {{ ui.icon('assessment', 'md') }}
                                {{ 'Sync Status'|trans({}, 'Modules.Weprestaacf.Admin') }}
                            </h3>
                        </div>
                        <div class="card-body">
                            {# Status Overview #}
                            <div class="row text-center mb-4">
                                <div class="col">
                                    <div class="h4 mb-0">{{ syncStatus.db_count }}</div>
                                    <small class="text-muted">{{ 'In Database'|trans({}, 'Modules.Weprestaacf.Admin') }}</small>
                                </div>
                                <div class="col">
                                    <div class="h4 mb-0">{{ syncStatus.theme_count }}</div>
                                    <small class="text-muted">{{ 'In Theme'|trans({}, 'Modules.Weprestaacf.Admin') }}</small>
                                </div>
                                <div class="col">
                                    <div class="h4 mb-0 text-success">{{ syncStatus.synced }}</div>
                                    <small class="text-muted">{{ 'Synced'|trans({}, 'Modules.Weprestaacf.Admin') }}</small>
                                </div>
                                <div class="col">
                                    <div class="h4 mb-0 text-warning">{{ syncStatus.need_push }}</div>
                                    <small class="text-muted">{{ 'Need Push'|trans({}, 'Modules.Weprestaacf.Admin') }}</small>
                                </div>
                                <div class="col">
                                    <div class="h4 mb-0 text-info">{{ syncStatus.need_pull }}</div>
                                    <small class="text-muted">{{ 'Need Pull'|trans({}, 'Modules.Weprestaacf.Admin') }}</small>
                                </div>
                            </div>

                            {# Groups Table #}
                            {% if syncStatus.groups|length > 0 %}
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>{{ 'Group'|trans({}, 'Modules.Weprestaacf.Admin') }}</th>
                                            <th>{{ 'Status'|trans({}, 'Admin.Global') }}</th>
                                            <th>{{ 'Actions'|trans({}, 'Admin.Global') }}</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for group in syncStatus.groups %}
                                        <tr>
                                            <td>
                                                <strong>{{ group.title }}</strong>
                                                <br><small class="text-muted">{{ group.slug }}</small>
                                            </td>
                                            <td>
                                                {% if group.status == 'synced' %}
                                                    <span class="badge badge-success">{{ ui.icon('check_circle', 'xs') }} {{ 'Synced'|trans({}, 'Modules.Weprestaacf.Admin') }}</span>
                                                {% elseif group.status == 'modified' %}
                                                    <span class="badge badge-warning">{{ ui.icon('edit', 'xs') }} {{ 'Modified'|trans({}, 'Modules.Weprestaacf.Admin') }}</span>
                                                {% elseif group.status == 'need_push' %}
                                                    <span class="badge badge-info">{{ ui.icon('cloud_upload', 'xs') }} {{ 'Need Push'|trans({}, 'Modules.Weprestaacf.Admin') }}</span>
                                                {% elseif group.status == 'theme_only' %}
                                                    <span class="badge badge-primary">{{ ui.icon('cloud_download', 'xs') }} {{ 'Theme Only'|trans({}, 'Modules.Weprestaacf.Admin') }}</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if group.source == 'database' %}
                                                    <button type="button" class="btn btn-sm btn-outline-primary btn-sync-push" data-group-id="{{ group.id }}">
                                                        {{ ui.icon('cloud_upload', 'xs') }} {{ 'Push'|trans({}, 'Modules.Weprestaacf.Admin') }}
                                                    </button>
                                                {% endif %}
                                                {% if group.status == 'theme_only' or group.status == 'modified' %}
                                                    <button type="button" class="btn btn-sm btn-outline-info btn-sync-pull" data-slug="{{ group.slug }}">
                                                        {{ ui.icon('cloud_download', 'xs') }} {{ 'Pull'|trans({}, 'Modules.Weprestaacf.Admin') }}
                                                    </button>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% else %}
                            <div class="alert alert-secondary">
                                {{ 'No groups found.'|trans({}, 'Modules.Weprestaacf.Admin') }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                </div>

                <div class="col-xl-4">
                    {# Sync Actions Card #}
                    <div class="card mb-3">
                        <div class="card-header">
                            <h3 class="card-header-title">
                                {{ ui.icon('flash_on', 'md') }}
                                {{ 'Manual Sync'|trans({}, 'Modules.Weprestaacf.Admin') }}
                            </h3>
                        </div>
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                <button type="button" class="btn btn-primary btn-block mb-2" id="btn-sync-all" {% if not syncEnabled %}disabled{% endif %}>
                                    {{ ui.icon('sync', 'sm') }}
                                    {{ 'Sync All'|trans({}, 'Modules.Weprestaacf.Admin') }}
                                </button>
                                <button type="button" class="btn btn-outline-primary btn-block mb-2" id="btn-push-all" {% if not syncEnabled %}disabled{% endif %}>
                                    {{ ui.icon('cloud_upload', 'sm') }}
                                    {{ 'Push All to Theme'|trans({}, 'Modules.Weprestaacf.Admin') }}
                                </button>
                                <button type="button" class="btn btn-outline-info btn-block mb-2" id="btn-pull-all" {% if not syncEnabled %}disabled{% endif %}>
                                    {{ ui.icon('cloud_download', 'sm') }}
                                    {{ 'Pull All from Theme'|trans({}, 'Modules.Weprestaacf.Admin') }}
                                </button>
                            </div>

                            {% if not syncEnabled %}
                            <div class="alert alert-warning mt-3 mb-0">
                                {{ 'Enable JSON sync to use these features.'|trans({}, 'Modules.Weprestaacf.Admin') }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {# ========== Field Types Tab ========== #}
        <div class="tab-pane fade" id="fieldtypes" role="tabpanel">
            <div class="row">
                <div class="col-xl-8">
                    {# Field Types Table #}
                    <div class="card mb-4">
                        <div class="card-header">
                            <h3 class="card-header-title">
                                {{ ui.icon('category', 'md') }}
                                {{ 'Registered Field Types'|trans({}, 'Modules.Weprestaacf.Admin') }}
                            </h3>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>{{ 'Type'|trans({}, 'Modules.Weprestaacf.Admin') }}</th>
                                            <th>{{ 'Label'|trans({}, 'Admin.Global') }}</th>
                                            <th>{{ 'Category'|trans({}, 'Modules.Weprestaacf.Admin') }}</th>
                                            <th>{{ 'Source'|trans({}, 'Modules.Weprestaacf.Admin') }}</th>
                                            <th>{{ 'Actions'|trans({}, 'Admin.Global') }}</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for type, info in fieldTypes %}
                                        <tr>
                                            <td>
                                                <span class="material-icons text-muted mr-1" style="font-size: 18px; vertical-align: middle;">{{ info.icon }}</span>
                                                <code>{{ info.type }}</code>
                                            </td>
                                            <td>{{ info.label }}</td>
                                            <td>
                                                <span class="badge badge-secondary">{{ info.category }}</span>
                                            </td>
                                            <td>
                                                {% if info.source == 'core' %}
                                                    <span class="badge badge-success">{{ 'Core'|trans({}, 'Modules.Weprestaacf.Admin') }}</span>
                                                {% elseif info.source == 'theme' %}
                                                    <span class="badge badge-primary">{{ 'Theme'|trans({}, 'Modules.Weprestaacf.Admin') }}</span>
                                                {% elseif info.source == 'uploaded' %}
                                                    <span class="badge badge-info">{{ 'Uploaded'|trans({}, 'Modules.Weprestaacf.Admin') }}</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if info.can_delete %}
                                                <button type="button" class="btn btn-sm btn-outline-danger btn-delete-fieldtype" data-type="{{ info.type }}">
                                                    {{ ui.icon('delete', 'xs') }}
                                                </button>
                                                {% else %}
                                                <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-xl-4">
                    {# Upload Field Type - Uses JavaScript, not nested form #}
                    <div class="card mb-3">
                        <div class="card-header">
                            <h3 class="card-header-title">
                                {{ ui.icon('file_upload', 'md') }}
                                {{ 'Upload Field Type'|trans({}, 'Modules.Weprestaacf.Admin') }}
                            </h3>
                        </div>
                        <div class="card-body">
                            <div id="upload-fieldtype-container">
                                <div class="form-group">
                                    <label>{{ 'PHP File'|trans({}, 'Modules.Weprestaacf.Admin') }}</label>
                                    <input type="file" class="form-control-file" id="fieldtype-file-input" name="file" accept=".php">
                                    <small class="form-text text-muted">
                                        {{ 'File must extend AbstractFieldType. Naming: MyCustomField.php'|trans({}, 'Modules.Weprestaacf.Admin') }}
                                    </small>
                                </div>
                                <button type="button" class="btn btn-primary btn-block" id="btn-upload-fieldtype">
                                    {{ ui.icon('upload', 'sm') }}
                                    {{ 'Upload'|trans({}, 'Admin.Actions') }}
                                </button>
                            </div>
                        </div>
                    </div>

                    {# Discovery Paths #}
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-header-title">
                                {{ ui.icon('folder', 'md') }}
                                {{ 'Discovery Paths'|trans({}, 'Modules.Weprestaacf.Admin') }}
                            </h3>
                        </div>
                        <div class="card-body">
                            {% for source, path in discoveryPaths %}
                            <div class="mb-3">
                                <strong>{{ source|capitalize }}</strong>
                                {% if path.exists %}
                                    <span class="badge badge-success">{{ path.count }} {{ 'types'|trans({}, 'Modules.Weprestaacf.Admin') }}</span>
                                {% else %}
                                    <span class="badge badge-secondary">{{ 'Not found'|trans({}, 'Admin.Global') }}</span>
                                {% endif %}
                                <br>
                                <small class="text-muted text-break">{{ path.path }}</small>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {{ form_end(configurationForm) }}
</div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="{{ asset('../modules/wepresta_acf/views/dist/admin.js') }}"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Tab persistence
        const hash = window.location.hash;
        if (hash) {
            const tab = document.querySelector('a[href="' + hash + '"]');
            if (tab) {
                new bootstrap.Tab(tab).show();
            }
        }

        // Save active tab to URL
        document.querySelectorAll('#configTabs a').forEach(function(tab) {
            tab.addEventListener('shown.bs.tab', function(e) {
                history.replaceState(null, null, e.target.getAttribute('href'));
            });
        });

        // Toggle custom path field
        const pathTypeSelect = document.getElementById('sync_path_type') || document.querySelector('[id$="_sync_path_type"]');
        const customPathGroup = document.getElementById('custom_path_group');

        if (pathTypeSelect && customPathGroup) {
            function toggleCustomPath() {
                customPathGroup.style.display = pathTypeSelect.value === 'custom' ? 'flex' : 'none';
            }
            pathTypeSelect.addEventListener('change', toggleCustomPath);
            toggleCustomPath();
        }

        // API base URL - use Symfony router to get correct path
        const apiBase = '{{ path('wepresta_acf_api_groups_list')|split('/groups')[0] }}';

        // Sync actions
        document.getElementById('btn-push-all')?.addEventListener('click', async function() {
            if (!confirm('{{ 'Push all groups to theme?'|trans({}, 'Modules.Weprestaacf.Admin') }}')) return;
            try {
                const response = await fetch(apiBase + '/sync/push-all', { method: 'POST' });
                const data = await response.json();
                alert(data.success ? 'Pushed ' + data.data.pushed + ' groups' : 'Error: ' + data.error);
                location.reload();
            } catch (e) {
                alert('Error: ' + e.message);
            }
        });

        document.getElementById('btn-pull-all')?.addEventListener('click', async function() {
            if (!confirm('{{ 'Pull all groups from theme? This may overwrite existing data.'|trans({}, 'Modules.Weprestaacf.Admin') }}')) return;
            try {
                const response = await fetch(apiBase + '/sync/pull-all', { method: 'POST' });
                const data = await response.json();
                alert(data.success ? 'Pulled ' + data.data.pulled + ' groups' : 'Error: ' + data.error);
                location.reload();
            } catch (e) {
                alert('Error: ' + e.message);
            }
        });

        // Individual push/pull buttons
        document.querySelectorAll('.btn-sync-push').forEach(function(btn) {
            btn.addEventListener('click', async function() {
                const groupId = this.dataset.groupId;
                try {
                    const response = await fetch(apiBase + '/sync/push/' + groupId, { method: 'POST' });
                    const data = await response.json();
                    alert(data.success ? 'Group pushed successfully' : 'Error: ' + data.error);
                    location.reload();
                } catch (e) {
                    alert('Error: ' + e.message);
                }
            });
        });

        document.querySelectorAll('.btn-sync-pull').forEach(function(btn) {
            btn.addEventListener('click', async function() {
                const slug = this.dataset.slug;
                try {
                    const response = await fetch(apiBase + '/sync/pull/' + slug, { method: 'POST' });
                    const data = await response.json();
                    alert(data.success ? 'Group pulled successfully' : 'Error: ' + data.error);
                    location.reload();
                } catch (e) {
                    alert('Error: ' + e.message);
                }
            });
        });

        // Upload field type (using button click, not form submit to avoid nested forms)
        document.getElementById('btn-upload-fieldtype')?.addEventListener('click', async function() {
            const fileInput = document.getElementById('fieldtype-file-input');
            if (!fileInput || !fileInput.files.length) {
                alert('Please select a file');
                return;
            }
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            try {
                const response = await fetch(apiBase + '/field-types/upload', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                alert(data.success ? 'Field type uploaded successfully' : 'Error: ' + data.error);
                if (data.success) location.reload();
            } catch (e) {
                alert('Error: ' + e.message);
            }
        });

        // Delete field type
        document.querySelectorAll('.btn-delete-fieldtype').forEach(function(btn) {
            btn.addEventListener('click', async function() {
                const type = this.dataset.type;
                if (!confirm('{{ 'Delete this field type?'|trans({}, 'Modules.Weprestaacf.Admin') }}')) return;
                try {
                    const response = await fetch(apiBase + '/field-types/' + type, { method: 'DELETE' });
                    const data = await response.json();
                    alert(data.success ? 'Field type deleted' : 'Error: ' + data.error);
                    if (data.success) location.reload();
                } catch (e) {
                    alert('Error: ' + e.message);
                }
            });
        });
    });
    </script>
{% endblock %}
