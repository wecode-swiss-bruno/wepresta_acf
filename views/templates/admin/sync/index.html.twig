{#
 * WePresta ACF - Sync (Export/Import) Main Page
 #}

{% extends '@Modules/wepresta_acf/views/templates/admin/_layout/admin_base.html.twig' %}

{# Import Macros #}
{% import '@Modules/wepresta_acf/src/Wedev/Extension/UI/Twig/Macros/admin.html.twig' as ui %}
{% import '@Modules/wepresta_acf/views/templates/admin/_macros/common.html.twig' as common %}

{# Define toolbar buttons - must be array, not macro result #}
{% set layoutHeaderToolbarBtn = {
    'save': {
        'href': '#',
        'desc': 'Save'|trans({}, 'Admin.Actions'),
        'icon': 'save',
        'class': 'btn-primary',
        'js': 'return false;'
    }
} %}

{% block page_content %}

<div class="wepresta_acf-sync">
    <div class="row">
        <div class="col-12">
            {# Auto-Sync Section #}
            {% set auto_sync_content %}
                <form id="sync-form" method="post" action="{{ path('wepresta_acf_sync') }}">
                    {{ form_widget(syncForm._token) }}
                    <div class="form-group row">
                        <label class="form-control-label col-sm-3">
                            {{ form_label(syncForm.auto_sync_enabled) }}
                        </label>
                        <div class="col-sm-9">
                            {{ form_widget(syncForm.auto_sync_enabled) }}
                            {{ form_errors(syncForm.auto_sync_enabled) }}
                            <small class="form-text text-muted d-block mt-2">
                                {{ 'When enabled, the configuration will be automatically exported to /modules/wepresta_acf/sync/acf-config.json after each modification (create, update, or delete) of a group or field. This file can be versioned in Git to synchronize configurations between staging and production environments. The export runs in the background and does not slow down your operations.'|trans({}, 'Modules.Weprestaacf.Admin') }}
                            </small>
                        </div>
                    </div>
                </form>

                {# Auto-Sync Status Section - Only visible if auto-sync is enabled #}
                <div id="auto-sync-status-section" class="mt-3" {% if not autoSyncEnabled %}style="opacity: 0.5; pointer-events: none; user-select: none;"{% endif %}>
                    {% if autoSyncEnabled %}
                        {% if syncStatus %}
                            {% if syncStatus.status == 'synced' %}
                                {# Synchronized - Show "Sync OK" #}
                                <div class="alert alert-success">
                                    <div class="d-flex align-items-center">
                                        <i class="material-icons mr-2">check_circle</i>
                                        <strong>{{ 'Sync OK'|trans({}, 'Modules.Weprestaacf.Admin') }}</strong>
                                        <span class="ml-2">{{ 'Configuration is synchronized.'|trans({}, 'Modules.Weprestaacf.Admin') }}</span>
                                    </div>
                                </div>
                            {% else %}
                                {# Not synchronized - Show "Sync NOW" button #}
                                <div class="alert alert-warning">
                                    <div class="d-flex align-items-center mb-2">
                                        <i class="material-icons mr-2">sync_problem</i>
                                        <strong>{{ 'Configuration not synchronized'|trans({}, 'Modules.Weprestaacf.Admin') }}</strong>
                                    </div>
                                    <p class="mb-2">{{ syncStatus.message|trans({}, 'Modules.Weprestaacf.Admin') }}</p>
                                    <button type="button" class="btn btn-primary" id="btn-sync-now">
                                        <i class="material-icons">sync</i>
                                        {{ 'Sync NOW'|trans({}, 'Modules.Weprestaacf.Admin') }}
                                    </button>
                                </div>
                            {% endif %}
                        {% else %}
                            {# Status not available - Show "Sync NOW" button #}
                            <div class="alert alert-info">
                                <button type="button" class="btn btn-primary" id="btn-sync-now">
                                    <i class="material-icons">sync</i>
                                    {{ 'Sync NOW'|trans({}, 'Modules.Weprestaacf.Admin') }}
                                </button>
                            </div>
                        {% endif %}
                    {% else %}
                        {# Auto-sync disabled - Show disabled message #}
                        <div class="alert alert-secondary">
                            <i class="material-icons">info</i>
                            <span>{{ 'Enable auto-sync above to use synchronization features.'|trans({}, 'Modules.Weprestaacf.Admin') }}</span>
                        </div>
                    {% endif %}
                </div>
            {% endset %}
            {{ common.card('Auto-Sync'|trans({}, 'Modules.Weprestaacf.Admin'), 'sync', 'md', auto_sync_content) }}

            {# Export / Import Cards #}
            {% set export_import_content %}
                <p class="text-muted mb-4">
                    {{ 'Export your field groups to JSON files or import them from JSON files.'|trans({}, 'Modules.Weprestaacf.Admin') }}
                </p>

                <div class="row">
                    {# Export Card #}
                    <div class="col-md-6 mb-4">
                        <div class="card h-100 sync-card" data-action="export" style="cursor: pointer; transition: transform 0.2s;">
                            <div class="card-body text-center p-5">
                                <div class="mb-3">
                                    <i class="material-icons" style="font-size: 64px; color: #25b9d7;">cloud_download</i>
                                </div>
                                <h4 class="card-title">{{ 'Export'|trans({}, 'Modules.Weprestaacf.Admin') }}</h4>
                                <p class="text-muted">
                                    {{ 'Export field groups to JSON files for backup or migration.'|trans({}, 'Modules.Weprestaacf.Admin') }}
                                </p>
                            </div>
                        </div>
                    </div>

                    {# Import Card #}
                    <div class="col-md-6 mb-4">
                        <div class="card h-100 sync-card" data-action="import" style="cursor: pointer; transition: transform 0.2s;">
                            <div class="card-body text-center p-5">
                                <div class="mb-3">
                                    <i class="material-icons" style="font-size: 64px; color: #25b9d7;">cloud_upload</i>
                                </div>
                                <h4 class="card-title">{{ 'Import'|trans({}, 'Modules.Weprestaacf.Admin') }}</h4>
                                <p class="text-muted">
                                    {{ 'Import field groups from JSON files.'|trans({}, 'Modules.Weprestaacf.Admin') }}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            {% endset %}
            {{ common.card('Export / Import'|trans({}, 'Modules.Weprestaacf.Admin'), 'swap_horiz', 'md', export_import_content) }}
        </div>
    </div>
</div>

{% endblock %}

{% block extra_javascripts %}
    <script src="{{ asset('../modules/wepresta_acf/views/js/admin/sync.js') }}"></script>
    <script>
    window.acfSyncConfig = {
        apiBase: '{{ path('wepresta_acf_api_export_all') | replace({'/export/all': ''}) }}',
        toggleUrl: '{{ path('wepresta_acf_api_auto_sync_toggle') }}',
        exportNowUrl: '{{ path('wepresta_acf_api_auto_sync_export_now') }}',
        importFromSyncUrl: '{{ path('wepresta_acf_api_auto_sync_import') }}',
        dismissNotificationUrl: '{{ path('wepresta_acf_api_auto_sync_dismiss') }}',
        syncNowUrl: '{{ path('wepresta_acf_api_auto_sync_now') }}',
        autoSyncEnabled: {{ autoSyncEnabled ? 'true' : 'false' }},
        fileInfo: {{ fileInfo|json_encode|raw }},
        syncStatus: {{ syncStatus|json_encode|raw }},
    };

    document.addEventListener('DOMContentLoaded', function() {
        // Setup Save button in toolbar - submits the form
        const saveBtn = document.querySelector('[id*="save"]');
        if (saveBtn) {
            saveBtn.addEventListener('click', function(e) {
                e.preventDefault();
                const form = document.getElementById('sync-form');
                if (form) {
                    form.submit();
                }
            });
        }

        const cards = document.querySelectorAll('.sync-card');
        
        cards.forEach(card => {
            card.addEventListener('click', function() {
                const action = this.dataset.action;
                if (action === 'export') {
                    window.location.href = '{{ path('wepresta_acf_sync_export') }}';
                } else if (action === 'import') {
                    window.location.href = '{{ path('wepresta_acf_sync_import') }}';
                }
            });

            card.addEventListener('mouseenter', function() {
                this.style.transform = 'translateY(-5px)';
                this.style.boxShadow = '0 4px 8px rgba(0,0,0,0.1)';
            });

            card.addEventListener('mouseleave', function() {
                this.style.transform = 'translateY(0)';
                this.style.boxShadow = '';
            });
        });
    });
    </script>
{% endblock %}
